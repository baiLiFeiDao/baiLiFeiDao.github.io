---
title: 卡充值流程
date: 2023-09-19 09:51:52
tags:
- 第三方支付
password: qianjw123
---

![image-20230919135756343](C:\Users\allinpay\AppData\Roaming\Typora\typora-user-images\image-20230919135756343.png)

## 卡充值是什么

指用户通过绑定的银行卡转入app内的余额，很多app都会有这个功能，典型的有微信的零钱和支付宝的余额。

挖个坑，为什么余额宝必须转入余额，才能转出到银行卡，而余额宝可以直接通过银行卡充值。

## 卡充值的流程

### 代收开始

传入相应的参数，比如密码、认证方式、充值数额

### 支付认证

如果认证方式为空，则检查支付密码是否为空，以及支付密码是否正确

如果认证方式不为空，则进行生物信息验证（指纹、面容等）

```mermaid
graph TD;
verify是否为空-->|是|支付密码是否为空-->|是|抛出异常:未设置支付密码;
支付密码是否为空-->|否|验证密码是否正确-->|是|结束;
验证密码是否正确-->|否|抛出异常:支付密码不正确;
verify是否为空-->|否|进行生物信息验证-->|验证成功|存入缓存,结束;
进行生物信息验证-->|验证失败|抛出异常:交易失败;
```

### 组装支付参数

| 参数名     | 描述             | 备注                                                         |
| ---------- | ---------------- | ------------------------------------------------------------ |
| userId     |                  |                                                              |
| txnCd      | 交易类型         | 代收(√)、代付、签约、账户、POS                               |
| txnAmt     | 充值时的选取金额 |                                                              |
| cardNo     | 卡号             |                                                              |
| cardName   | 用户名           |                                                              |
| detailType | 详细类型         | 代收（√）、代付、提现、网银充值、POS充值                     |
| systemType |                  | 00                                                           |
| agrmno     | 快捷签约协议号   | 如未快捷签约，返回空串。tbl_bind_card的ext1字段代表快捷签约协议号。默认走商委渠道 |
| ip         | ip地址           |                                                              |

### 支付网关

#### 组装订单信息

将交易金额传入订单信息中

将订单信息放入支付参数中

#### 校验卡信息

```mermaid
graph TD;
用户信息是否为空-->|是|抛出异常:邮政经理信息不存在;
用户信息是否为空-->|否|获取用户所属机构号-->设置支付渠道,若渠道错误,抛出异常:渠道信息错误;

```

#### 基本信息检查

检查用户是否存在

检查用户状态是否为00：   状态编码，00启用，01禁用  03 待审核  04 注销 05 未通过 06 删除

检查交易类型，用户是否开通该交易类型

校验银行信息，卡号是否支持

#### 路由渠道以及渠道商户号

路由信息

![image-20230919105737305](D:\project\Blog\Blog\source\images\image-20230919105737305.png)

根据交易类型和路由状态，得到路由列表

寻找路由列表中路由等级为0的作为默认路由

根据默认路由信息得到的渠道代码和机构号，获取渠道信息



#### 代收不涉及这部分校验，直接创建支付订单

```mermaid
graph TD;
交易类型是否为代付-->|是|同机构校验-->|是同机构|短时间内是否重复交易-->|是|结束;
短时间内是否重复交易-->|否|创建支付订单;
同机构校验-->|不是同机构|抛出异常:机构信息不匹配;
交易类型是否为代付-->|否|创建支付订单;
```



#### 创建支付订单

权限检查

```mermaid
graph TD;
权限检查-->|执行代付|交易对应的风控信息是否配置-->|否|抛出异常:该交易风控信息未配置;
交易对应的风控信息是否配置-->|是|判断交易时间是否在风控信息配置规定的时间内-->判断交易金额是否处在最小金额和最大金额之间-->获取渠道费率信息,具体信息如下图-->根据获取的渠道费率信息计算手续费-->账户信息是否为空-->|是|回滚交易;
账户信息是否为空-->|否|机构垫付手续费-->银行是否承担手续费-->|是|检查当前账户余额是否小于交易金额-->|是|抛出异常:账户余额不足;
银行是否承担手续费-->|否|检查当前账户余额是否小于交易金额+手续费-->|是|抛出异常:账户余额不足;
检查当前账户余额是否小于交易金额-->|否|保存账户流水记录;
检查当前账户余额是否小于交易金额+手续费-->|否|保存账户流水记录;
保存账户流水记录-->保存订单数据-->新增订单是否成功-->|否|新增代付订单失败;
新增订单是否成功-->|是|更新收购订单交易号-->记录账户流水,比如变动后的账户余额,冻结额度等等-->账户信息变更-->|账户变更成功|提交账务,账户冻结成功;
账户信息变更-->|账户变更失败|回滚账务,账户冻结失败;
```

![image-20230919113141615](D:\project\Blog\Blog\source\images\屏幕截图 2023-09-19 113114.png)

```mermaid
graph TD;
装填交易信息-->调用风控接口-->|风控接口拒绝|抛出异常:风控策略拒绝;
调用风控接口-->|风控接口接受|通联通支付请求-->代付且交易失败-->|是|结束;
代付且交易失败-->|否|异步上报风控交易结果-->组装支付结果参数,返回-->卡充值是否成功
```



